# 传输层-协议数据单元

[[toc]]

## TCP 段格式

IP 数据报
![IP数据报](https://image-bucket-1307756649.cos.ap-chengdu.myqcloud.com/image/20250713105045169.png)
下图表示的是 TCP 首部的数据格式：
![TCP 首部](https://image-bucket-1307756649.cos.ap-chengdu.myqcloud.com/image/20250713105130919.png)

- 源/目的端口 ​：标识发送和接收的应用程序（如 80=HTTP）。
- 序列号/确认号 ​：实现可靠传输（防止丢包、乱序）。
- 控制标志 ​：管理连接状态（如 SYN 发起连接，FIN 关闭连接）。
- 窗口大小 ​：流量控制（接收方可用的缓冲区大小）。

## UDP 数据报格式

![UDP 数据报格式](https://image-bucket-1307756649.cos.ap-chengdu.myqcloud.com/image/20250713105205383.png)

## IP 分片和 TCP 分段的区别

TCP 分段（Segmentation）​​ 和 ​IP 分片（Fragmentation）​​ 是两个独立的过程，但共同协作以适应网络传输：

- ​TCP 分段 ​：由传输层（TCP 协议）主动将应用数据分割为适合网络传输的 ​MSS（Maximum Segment Size 最大报文段长度）​。TCP 分段是在传输层重组
- ​IP 分片 ​：由网络层（IP 协议）被动将过大的数据包分割为 ​MTU（最大传输单元）​​ 大小的片段。IP 分片是在网络层重组

以 HTTP 传输为例

1. TCP 分段 ​：应用层发送一个 2000 字节的 HTTP 数据 → TCP 层按 ​MSS（如 1460 字节）​​ 分成 2 个段：

   - 段 1：1460 字节（TCP 头 20 字节 + 数据 1440 字节）
   - 段 2：560 字节（TCP 头 20 字节 + 数据 540 字节）

2. IP 封装：每个 TCP 段加上 IP 头（20 字节），形成 IP 包

   - IP 包 1：1480 字节（IP 头 20 + TCP 段 1460）
   - IP 包 2：580 字节（IP 头 20 + TCP 段 560）

3. ​IP 分片（若 MTU 限制）​​：如果某链路 MTU=1000 字节
   - IP 包 1​（1480 字节）会被分片：
     - 分片 1：1000 字节（IP 头 20 + 数据 980，MF=1）
     - 分片 2：500 字节（IP 头 20 + 数据 480，MF=0）
   - ​IP 包 2​（580 字节）无需分片（≤MTU）。
4. 接收端处理 ​：
   - 网络层 ​：收到分片 1 和分片 2 后，重组为原始 IP 包 1，直接接收 IP 包 2
   - 传输层 ​：解封装 IP 包 1/2，得到 TCP 段 1/2，按序列号重组为 2000 字节 HTTP 数据
   - 应用层 ​：通过目标端口（如 80）将数据交给 Web 服务器进程（如 Nginx）。
