# TCP 和 IP 协议

[[toc]]

TCP 和 UDP 协议是传输层的协议

## TCP 协议

### 基本概念

TCP 是面向连接的、一对一的、可靠的、全双工通信的、面向字节流的传输层协议。
TCP 采用滑动窗口+累积确认进行流量控制和拥塞控制，采用与 UDP 相同的校验方法进行校验。
::: tip 可靠
如果一个协议使用确认机制对传输的数据进行确认，那么可以认为它是一个可靠的协议
:::

### 协议数据单元

TCP 传送的数据单元称为报文段。TCP 报文段既可以用来运载数据，又可以用来建立连接、释放连接和应答。一个 TCP 报文段分为首部和数据两部分，整个 TCP 报文段作为 IP 数据报的数据部分封装在 IP 数据报中，如图 5.6 所示。其首部的前 20B 是固定的。TCP 首部最短为 20B,最长为 60B，后面有 4N 字节是根据需要而增加的选项，长度为 4B 的整数倍。
![协议数据单元](https://image-bucket-1307756649.cos.ap-chengdu.myqcloud.com/image/20250714113610900.png)

- 源端口和目的端口:各占 2B。端口是传输层与应用层的服务接口，传输层的复用和分用功能都要通过端口实现。
- 序号:占 4B，范围为`0〜2^32- 1`,共`2^32`个序号。TCP 是面向字节流的（即 TCP 传送时是逐个字节传送的），所以 TCP 连接传送的字节流中的每个字节都按顺序编号。序号字段的值指的是本报文段所发送的数据的第一个字节的序号。例如，一报文段的序号字段值是 301,而携带的数据共有 100B,表明本报文段的数据的第一个字节序号为 301，最后一个字节的序号是 400，因此下一个报文段的数据序号应从 401 开始。
- 确认号:期望收到对方下一个报文段的第一个数据字节的序号。前面的所有字节序号已经确认
- 数据偏移（即首部长度）:表示首部长度（首部中还有长度不确定的选项字段，所以可变长），最大 60B，基本单位 4B，即数据起始处距离 TCP 报文段的起始处有多少个 4B。
- 保留：占 6 位，保留为今后使用，但目前应置为 0。
- 紧急位 URG：紧急指针字段启用标志，1 表示启用，0 表示禁用。表示有高优先级数据要发送，数据从第一个字节到紧急指针所指字节就是紧急数据
- 确认位 ACK（Acknowledge Character）：仅当 ACK= 1 时确认号字段才有效。当 ACK = 0 时，确认号无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。
- 同步位 SYN（Synchronize）：当 SYN= 1 时表示这是一个连接请求或连接接受报文。当 SYN=1, ACK = 0 时，表明这是一个连接请求报文，对方若同意建立连接，则应在响应报文中使用 SYN=1, ACK=1
- 终止位 FIN （Finish）：用来释放一个请求。当 FIN= 1 时，表明此报文段的发送已发送完毕，并要求释放运输连接。

::: tip MSS（Maximum Segment Size 最大报文段长度）
TCP 和 UDP 在发送报文时所采用的方式完全不同。UDP 报文的长度由发送应用进程决定，而 TCP 报文的长度则根据接收方给出的窗口值和当前网络拥塞程度来决定。如果应用进程传送到 TCP 缓存的数据块太长，TCP 就把它划分得短一些再传送；如果太短，TCP 也可以等到积累足够多的字节后再构成报文段发送出去。
:::

### 工作原理

### 使用 TCP 的应用层协议

::: tip 所谓使用某一层协议
就是将本层数据作为某一层协议的协议数据单元，或者说添加某一层协议的首部
:::

## UDP 协议

### 基本概念

UDP 是一个无连接的非可靠传输层协议。它在 IP 之上仅提供两个附加服务：多路复用和对数据的错误检查。UDP 在传送数据之前不需要先建立连接，远程主机的传输层收到 UDP 报文后，不需要给出任何确认。由于 UDP 比较简单，因此执行速度比较快、实时性好。

### 协议数据单元

UDP 是面向报文的。发送方 UDP 对应用层交下来的报文，在添加首部后就向下交付给 IP 层，**一次发送一个报文，既不合并，也不拆分**，而是保留这些报文的边界
UDP 首部和用户数据。UDP 首部有 8B,由 4 个字段组成，每个字段的长度都是 2B
![UDP 数据报格式](https://image-bucket-1307756649.cos.ap-chengdu.myqcloud.com/image/20250713105205383.png)

- 源端口号：在需要对方回信时选用，不需要时可用全 0
- 目的端口号：这在终点交付报文时必须使用到。
- 长度：UDP 数据报的长度（包括首部和数据），其最小值是 8 （仅有首部）。
- 校验和：检测 UDP 数据报在传输中是否有错。有错就丢弃。该字段是可选的，当源主机不想计算校验和时，则直接令该字段为全 0。

### 工作原理

当传输层从 IP 层收到 UDP 数据报时，就根据首部中的目的端口，把 UDP 数据报通过相应的端口上交给应用进程，如图所示。如果接收方 UDP 发现收到的报文中的目的端口号不正确(即不存在对应于端口号的应用进程),那么就丢弃该报文，并由 ICMP 发送“端口不可达”差错报文给发送方。
![工作原理](https://image-bucket-1307756649.cos.ap-chengdu.myqcloud.com/image/20250714111851699.png)

### 使用 UDP 的应用层协议

- 小文件传送协议（TFTP）
- DNS
- SNMP
- 实时传输协议（RTP）

### 差错校验

UDP 头部包含一个 ​16 位的校验和字段，用于检测数据在传输过程中是否发生错误（如比特翻转）。
发送方计算数据报（头部+伪头部+数据）的校验和，接收方验证该校验和。如果校验失败，UDP ​ 直接丢弃数据报，但不会通知发送方或要求重传。
![差错校验](https://image-bucket-1307756649.cos.ap-chengdu.myqcloud.com/image/20250714112633368.png)
