# å“åº”è§£æå™¨

[[toc]]

å“åº”è§£æå™¨æ˜¯è¯·æ±‚å¤„ç†æ‹¦æˆªå™¨çš„ç»„æˆéƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè´Ÿè´£å¤„ç†è¯·æ±‚è¿”å›å“åº”

## å“åº”è§£æå™¨çš„å‚æ•°

å“åº”è§£æå™¨æ˜¯ä¸€ä¸ªå‡½æ•°åŒ…å«å¦‚ä¸‹å‚æ•°ï¼š

| Property    | Type                                 | Description                                                                                             |
| ----------- | ------------------------------------ | ------------------------------------------------------------------------------------------------------- |
| `request`   | `Request`                            | Fetch API Request representation of the intercepted request.<br>è·å– API Request è¡¨ç¤ºè¢«æ‹¦æˆªè¯·æ±‚çš„å†…å®¹ã€‚ |
| `requestId` | `string`                             | UUID representing the intercepted request.<br>ä»£è¡¨è¢«æ‹¦æˆªè¯·æ±‚çš„ UUID                                     |
| `params`    | `Record<string, string \| string[]>` | Request path parameters (e.g. `:userId`).<br>è¯·æ±‚è·¯å¾„å‚æ•°ï¼ˆä¾‹å¦‚ `:userId`ï¼‰                             |
| `cookies`   | `Record<string, string>`             | Parsed request cookies.<br>è§£æçš„è¯·æ±‚ cookies.                                                          |

```js
http.get('/resource', ({ request, params, cookies }) => {});
```

## å¤„ç†è·¯å¾„å‚æ•°

### è·å–ä¸€èˆ¬è·¯å¾„å‚æ•°

ä½ å¯ä»¥é€šè¿‡åœ¨è¯·æ±‚å¤„ç†ç¨‹åºçš„è·¯å¾„ä¸­åŒ…å«å†’å·`:`åè·Ÿå‚æ•°åæ¥å®šä¹‰è·¯å¾„å‚æ•°

```js
//         ğŸ‘‡ describe parameter types
http.get < { id: string } > ('/posts/:id', () => {});
//
```

è·¯å¾„å‚æ•°è¡¨ç¤ºè¯·æ±‚ URL ä¸­çš„åŠ¨æ€éƒ¨åˆ†ï¼Œä¸ä¼šè¢«å­—é¢åŒ¹é…ã€‚ç›¸åï¼Œå‚æ•°ä½ç½®ä¸Šçš„ä»»ä½•å­—ç¬¦ä¸²éƒ½å°†å­˜å‚¨åœ¨å“åº”è§£æå™¨å‚æ•°ä¸­æš´éœ²çš„ `params` å¯¹è±¡ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡å“åº”è§£æå™¨å‚æ•°ä¸­çš„ params å¯¹è±¡è®¿é—®è·¯å¾„å‚æ•°çš„å€¼ã€‚

```js
http.get <
  { id: string } >
  ('/posts/:id',
  ({ params }) => {
    const { id } = params;
  });
```

### è·å–é‡å¤è·¯å¾„å‚æ•°

å°†åŠ å·ï¼ˆ`+`ï¼‰ç”¨ä½œè·¯å¾„å‚æ•°çš„åç¼€ï¼Œä»¥è¡¨ç¤ºå…¶å€¼é‡å¤ã€‚é‡å¤çš„è·¯å¾„å‚æ•°å°†åœ¨ `params` å¯¹è±¡ä¸­ä»¥å€¼æ•°ç»„çš„å½¢å¼è¡¨ç¤ºã€‚

```js
http.get<{ segments: string[] }>('/settings/:segments+', ({ params }) => {
  console.log(params.segments)
})
```

| Request URL                   | params.segments               |
| ----------------------------- | ----------------------------- |
| `/settings/user`              | `["user"]`                    |
| `/settings/user/privacy`      | `["user", "privacy"]`         |
| `/settings/user/profile/edit` | `["user", "profile", "edit"]` |

## å¤„ç†æŸ¥è¯¢å‚æ•°

### è¯»å–å•ä¸ªæŸ¥è¯¢å‚æ•°

æ‚¨å¯ä»¥é€šè¿‡ä»`request.url`å­—ç¬¦ä¸²åˆ›å»º URL å¹¶è®¿é—®å…¶`searchParams`å±æ€§æ¥è¯»å–è¯·æ±‚çš„æŸ¥è¯¢å‚æ•°ã€‚

```js
http.get('/product', ({ request }) => {
  const url = new URL(request.url);

  // Given a request url of "/product?id=1",
  // the `productId` will be a "1" string.
  const productId = url.searchParams.get('id');

  if (!productId) {
    return new HttpResponse(null, { status: 404 });
  }

  return HttResponse.json({ id: productId });
});
```

`url.searchParams` æ˜¯ `URLSearchParams` çš„ä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨åƒ `.get()` å’Œ `.getAll()` è¿™æ ·çš„æ–¹æ³•è·å–æŸ¥è¯¢å‚æ•°çš„å€¼ã€‚

### è¯»å–å¤šå€¼æŸ¥è¯¢å‚æ•°

`URLSearchParams.prototype.getAll()` æ–¹æ³•è·å–å¤šå€¼æŸ¥è¯¢å‚æ•°çš„å€¼åˆ—è¡¨ã€‚

```js
http.get('/products', ({ request }) => {
  const url = new URL(request.url);

  // Given a request url of "/products?id=1&id=2&id=3",
  // the `productIds` will be an array of ["1", "2", "3"].
  const productIds = url.searchParams.getAll('id');
});
```

### å†™å…¥æŸ¥è¯¢å‚æ•°

è™½ç„¶ request å¯¹è±¡ä»£è¡¨ä¸€ä¸ªå·²ç»å‘ç”Ÿçš„ Fetch API è¯·æ±‚ ï¼Œä¸”æ— æ³•æ›´æ”¹ï¼Œä½†ä½ ä»ç„¶å¯ä»¥æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤å…¶æŸ¥è¯¢å‚æ•°ï¼Œå¦‚æœä½ å¸Œæœ› å°†è¯¥è¯·æ±‚è½¬å‘åˆ°å…¶ä»–åœ°æ–¹ã€‚

```js
http.get('/user', ({ request }) => {
  const url = new URL(request.url);
  url.searchParams.set('id', 'another-id');

  // Create a proxy request that extends the intercepted request
  // but has modified query parameters in its URL.
  const proxyRequest = new Request(url, request);
});
```

## å¤„ç†è¯·æ±‚ä½“

æ‚¨å¯ä»¥åƒé€šå¸¸è¯»å–ä»»ä½• Fetch API è¯·æ±‚ä¸€æ ·è¯»å–æˆªè·çš„è¯·æ±‚ä½“ã€‚åœ¨å“åº”è§£æå™¨å‚æ•°ä¸­è·å¾—çš„è¯·æ±‚å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¸¸è§„çš„è¯·æ±‚å®ä¾‹ï¼Œå¹¶ä¸”å¯ä»¥æŒ‰æ­¤æ“ä½œã€‚
ä¾‹å¦‚ï¼Œä½ å¯ä»¥è°ƒç”¨ `await request.json()` æ¥å°†è¯·æ±‚çš„æ­£æ–‡ä½œä¸º JSON è¯»å–ï¼Œ

```js
http.post < { id: string },
  Post >
    ('/posts/:id',
    async ({ request }) => {
      const newPost = await request.clone().json(); // Post
    });
```

::: warning æ³¨æ„
å¼ºçƒˆå»ºè®®åœ¨è¯»å–æ‹¦æˆªè¯·æ±‚çš„ body ä¹‹å‰å…ˆ å…‹éš† ä¸€ä»½è¯·æ±‚ã€‚è™½ç„¶å¦‚æœä½ æ‰“ç®—æ¨¡æ‹Ÿå“åº”ï¼Œç›´æ¥è¯»å–è¯·æ±‚ä½“æ˜¯å¯ä»¥çš„ï¼Œä½†åœ¨ `passthrough`ç»•è¿‡åœºæ™¯ä¸­ä¸è¿›è¡Œå…‹éš†å°±è¯»å–è¯·æ±‚ä½“ä¼šå¯¼è‡´å¼‚å¸¸ï¼ˆæµä¸èƒ½è¢«é‡å¤è¯»å–ï¼‰ã€‚å¯¹äºå…¶ä»–æ–¹æ³•ï¼Œå¦‚ `.text()ã€.formData()ã€.blob()` ç­‰ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚
:::

## å¤„ç† Cookies

æ‚¨å¯ä»¥é€šè¿‡å“åº”è§£æå™¨å‚æ•°ä¸­æä¾›ç»™æ‚¨çš„ `cookie` å¯¹è±¡è¯»å–è¯·æ±‚çš„ `cookie`ã€‚è™½ç„¶æ‚¨æ€»æ˜¯å¯ä»¥æ‰‹åŠ¨è¯»å– `request.headers.getï¼ˆ'cookie'ï¼‰`ï¼Œä½†ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ`cookie` å¯¹è±¡ä¼šä¸ºæ‚¨è§£æè¯·æ±‚ `cookie`ã€‚

```js
http.get('/api/user', ({ cookies }) => {
  if (!cookies.authToken) {
    return new HttpResponse(null, { status: 403 });
  }

  return HttpResponse.json({ name: 'John' });
});
```

## æ¨¡æ‹Ÿå“åº”

### å“åº”çš„ä¸‰éƒ¨åˆ†

1. å“åº”çŠ¶æ€ç ï¼šHTTP çŠ¶æ€ç ï¼Œå¦‚ 200ã€404ã€500 ç­‰

```js
http.get('/resource', () => {
  return new HttpResponse(null, { status: 404 });
});
```

2. å“åº”å¤´

```js
http.get('/resource', () => {
  return HttpResponse.json(
    { id: 'abc-123' },
    {
      headers: {
        'content-type': 'application/hal+json',
      },
    }
  );
});
```

3. å“åº”ä½“

ä½ å¯ä»¥ä½¿ç”¨æ‰€æœ‰æ”¯æŒçš„å“åº”ä½“ç±»å‹ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²ã€`Blobã€ArrayBufferã€FormDataã€URLSearchParams` å’Œ `ReadableStream` ä½œä¸ºæ¨¡æ‹Ÿå“åº”çš„æ­£æ–‡ã€‚

```js
http.get('/resource', () => {
  return HttpResponse.text('hello world');
});
```

### è¿”å›åŸå§‹å“åº”-passthrough

ä½ å¯ä»¥æŒ‰åŸæ ·æ‰§è¡Œè¢«æ‹¦æˆªçš„è¯·æ±‚ï¼Œå¹¶è¿”å›å…¶åŸå§‹å“åº”ï¼ˆå³é€ä¼ è¯·æ±‚ï¼‰ï¼Œæ–¹æ³•æ˜¯è¿”å› `passthrough()`å‡½æ•°è°ƒç”¨çš„ç»“æœ

```js
import { passthrough } from 'msw';

http.get('/resource', () => {
  return passthrough();
});
```

å½“ä½ åªæƒ³åœ¨ç‰¹å®šæƒ…å†µä¸‹æ¨¡æ‹Ÿå“åº”ï¼Œè€Œåœ¨å…¶ä»–æƒ…å†µä¸‹æŒ‰åŸæ ·æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œè¿™å°¤å…¶æœ‰ç”¨ã€‚

```js
http.get('https://api.example.com/resource', async ({ request }) => {
  const data = await request.clone().json();

  if (data?.id === 'abc-123') {
    return HttpResponse.json({ id: 'abc-123' });
  }

  return passthrough();
});
```

### ä¸è¿”å›ä»»ä½•å†…å®¹

æ‚¨ä¹Ÿå¯ä»¥æ˜¾å¼æˆ–éšå¼åœ°ä»å“åº”è§£æå™¨ä¸­ä¸è¿”å›ä»»ä½•å†…å®¹ã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼ŒMSW å°†ç»§ç»­å¯»æ‰¾å¯èƒ½åŒ¹é…æ­¤è¯·æ±‚çš„å…¶ä»–è¯·æ±‚å¤„ç†ç¨‹åºã€‚æ‚¨å¯ä»¥å°†å…¶ç”¨äºç½‘ç»œè‡ªæ£€æˆ–ä»»ä½•å…¶ä»–ä¸æ¶‰åŠå“åº”è¯·æ±‚çš„å‰¯ä½œç”¨ã€‚

```js
export const handlers = [
  http.get('/resource', ({ request }) => {
    console.log('Request intercepted!', request.method, request.url);
  }),
  http.get('/resource', () => {
    return HttpResponse.text('hello world');
  }),
];
```

è§£é‡Šï¼šåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚å¤„ç†ç¨‹åºå°†ä¼šåŒ¹é…ï¼Œè®°å½•æ¶ˆæ¯åˆ°æ§åˆ¶å°ï¼Œå¹¶ä¸”ç”±äºå®ƒæ²¡æœ‰è¿”å›ä»»ä½•å†…å®¹ï¼Œå¤„ç†ç»“æŸã€‚ç„¶åï¼Œç¬¬äºŒä¸ªè¯·æ±‚å¤„ç†ç¨‹åºå°†ä¼šåŒ¹é…åŒæ ·çš„è¯·æ±‚ï¼Œå¹¶ç”¨ä¸€ä¸ªæ¨¡æ‹Ÿçš„å“åº”æ¥å¤„ç†å®ƒï¼Œä½œä¸ºä¸€ä¸ªç¤ºä¾‹ã€‚

### é”™è¯¯å“åº”

ä½ å¯ä»¥é€šè¿‡æ„é€ ä¸€ä¸ªæœ‰æ•ˆçš„é”™è¯¯ `Response` å®ä¾‹å¹¶ä»å“åº”è§£æå™¨è¿”å›å®ƒï¼Œæ¥å¯¹æ‹¦æˆªçš„è¯·æ±‚åšå‡ºé”™è¯¯å“åº”ã€‚è¿™æ„å‘³ç€ä½¿ç”¨é”™è¯¯çŠ¶æ€ç ï¼ˆ`4xx/5xx`ï¼‰å¹¶å¯é€‰åœ°æä¾›ä»»ä½•è‡ªå®šä¹‰çš„å“åº”è´Ÿè½½ï¼Œä¾‹å¦‚é”™è¯¯ä¿¡æ¯ã€‚

```js
http.get <
  { id: string } >
  ('/books/:id',
  ({ params }) => {
    if (params.id === 'abc-123') {
      return new HttpResponse(null, { status: 404 });
    }

    return HttpResponse.json({
      id: params.id,
      title: 'The Lord of the Rings',
    });
  });
```

### ç½‘ç»œé”™è¯¯

ä½ å¯ä»¥ç”¨ `Response.error()` æ¥å“åº”è¢«æ‹¦æˆªçš„è¯·æ±‚ï¼Œè¿™ä¸ªæ ‡ç­¾ç”¨æ¥è¡¨ç¤ºç½‘ç»œé”™è¯¯ã€‚`Response.error()` é™æ€æ–¹æ³•ä¼šè¿”å›ä¸€ç§ç‰¹æ®Šçš„ `Response` å®ä¾‹ï¼Œè¿™ç§å®ä¾‹ä¸ä¼šè¢«å½“ä½œæ™®é€šçš„æœåŠ¡å™¨å“åº”å¤„ç†ã€‚ç›¸åï¼Œå®ƒä¼šå¯¼è‡´ç½‘ç»œé”™è¯¯ï¼Œä¸­æ­¢å¾…å¤„ç†çš„è¯·æ±‚ã€‚

```js
http.get('/resource', () => {
  return HttpResponse.error();
});
```

ä½¿ç”¨ `Response.error()` æ–¹æ³•æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯ï¼Œä¾‹å¦‚ï¼š

- DNS é”™è¯¯
- è¿æ¥è¶…æ—¶
- å®¢æˆ·ç«¯ç¦»çº¿

`WHATWG Fetch API` è§„èŒƒæ²¡æœ‰æä¾›è‡ªå®šä¹‰ç½‘ç»œé”™è¯¯ä¿¡æ¯çš„æ–¹æ³•ï¼Œå› æ­¤ä½ çš„å®¢æˆ·ç«¯ä¼šæ”¶åˆ°ä¸€ä¸ªé€šç”¨çš„ `TypeError: Failed to fetch` é”™è¯¯ï¼Œä½ éœ€è¦åœ¨è¯·æ±‚çš„ `.catch()` å›è°ƒä¸­å¤„ç†è¿™ä¸ªé”™è¯¯ã€‚

### äºŒè¿›åˆ¶å“åº”

ä½ å¯ä»¥å‘æ¨¡æ‹Ÿå“åº”å®ä¾‹æä¾›ä¸€ä¸ª `ArrayBuffer`ï¼Œä»¥å“åº”äºŒè¿›åˆ¶æ•°æ®ï¼Œæ¯”å¦‚å›¾ç‰‡ã€è§†é¢‘æˆ–éŸ³é¢‘ã€‚

```js
http.get('/images/:imageId', async ({ params }) => {
  // Get an ArrayBuffer from reading the file from disk or fetching it.
  const buffer = await fetch(`/static/images/${params.imageId}`).then(
    (response) => response.arrayBuffer()
  );

  return HttpResponse.arrayBuffer(buffer, {
    headers: {
      'content-type': 'image/png',
    },
  });
});
```

ä½¿ç”¨`HttpResponse.arrayBuffer()`é™æ€æ–¹æ³•å°†è‡ªåŠ¨åœ¨æ¨¡æ‹Ÿå“åº”ä¸Šè®¾ç½®`content-length`ã€‚ç¡®ä¿ä»ç„¶è®¾ç½®é€‚å½“çš„`content-type`å¤´ï¼

### æ¨¡æ‹Ÿ cookie

ä½¿ç”¨ç›´æ¥çš„ `Fetch API Response` å®ä¾‹æ¨¡æ‹Ÿå“åº” `cookies` è¯æ˜å­˜åœ¨é—®é¢˜ï¼Œå› ä¸º `Set-Cookie` å¤´æ˜¯ä¸èƒ½è®¾ç½®çš„ç¦æ­¢çš„å¤´ä¹‹ä¸€ã€‚MSW åœ¨å…¶ `HttpResponse` ç±»ä¸­ç»•è¿‡äº†è¿™ä¸€é™åˆ¶ï¼Œå…è®¸ä½ æ¨¡æ‹Ÿå“åº” `cookies`è€Œä¸å½±å“å“åº”çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚

```js
http.post('/login', () => {
  return new HttpResponse(null, {
    headers: {
      // Setting the "Set-Cookie" header on the mocked response
      // will set the cookies on the `document` as if they were
      // received from the server.
      'set-cookie': 'authToken=abc-123',
    },
  });
});
```

### é‡å®šå‘

ä½ å¯ä»¥é€šè¿‡æ„å»ºä¸€ä¸ªæœ‰æ•ˆçš„é‡å®šå‘ `Response` å®ä¾‹å¹¶ä»å“åº”è§£æå™¨ä¸­è¿”å›å®ƒæ¥æ¨¡æ‹Ÿé‡å®šå‘å“åº”ã€‚è¿™æ„å‘³ç€è®¾ç½®ä¸€ä¸ªé‡å®šå‘çŠ¶æ€ç  (3xx) å’ŒæŒ‡å‘ç›®æ ‡ URL çš„ `location` å¤´éƒ¨ã€‚

```js
http.get('/resource-a', () => {
  return new HttpResponse(null, {
    status: 301,
    headers: {
      location: '/resource-b',
    },
  });
});
```

### ç”Ÿæˆå™¨å‡½æ•°

ä½ å¯ä»¥åœ¨ JavaScript ä¸­ä½¿ç”¨ç”Ÿæˆå™¨å‡½æ•°ï¼ˆåŒ…æ‹¬å¼‚æ­¥ç”Ÿæˆå™¨ï¼‰åœ¨æ¯æ¬¡å¯¹åŒä¸€å¤„ç†ç¨‹åºçš„åç»­è¯·æ±‚ä¸­äº§ç”Ÿä¸åŒçš„å“åº”ã€‚è¿™åœ¨æè¿° HTTP è½®è¯¢æ—¶ç‰¹åˆ«æ–¹ä¾¿

```js
http.get<{ city: string }, never, { degree: number }>(
  '/weather/:city',
  function* () {
    let degree = 25

    while (degree < 27) {
      degree++
      yield HttpResponse({ degree })
    }

    degree++
    return HttpResponse.json({ degree })
  },
)
```

è¿™ä¸ª `GET /wheather/:city` è¯·æ±‚å¤„ç†ç¨‹åºåœ¨æ¯æ¬¡å“åº”æ—¶å¢åŠ  `degree`ï¼Œç›´åˆ°è¾¾åˆ° 28 åº¦ï¼š

```js
GET / weather / london; // { "degree": 26 }
GET / weather / london; // { "degree": 27 }
GET / weather / london; // { "degree": 28 }

// All subsequent requests will respond
// with the latest returned response.
GET / weather / london; // { "degree": 28 }
```

### æµå“åº”

ä½ å¯ä»¥é€šè¿‡æ„å»ºä¸€ä¸ª `ReadableStream` å®ä¾‹å¹¶å°†å…¶ä½œä¸ºæ¨¡æ‹Ÿå“åº”çš„æ­£æ–‡ï¼Œæ¥ç”¨æ•°æ®æµå“åº”è¢«æ‹¦æˆªçš„è¯·æ±‚ã€‚

```js
http.get('/stream', () => {
  const stream = new ReadableStream({
    start(controller) {
      controller.enqueue(new TextEncoder().encode('hello'));
      controller.enqueue(new TextEncoder().encode('world'));
      controller.close();
    },
  });

  return new HttpResponse(stream, {
    headers: {
      'content-type': 'text/plain',
    },
  });
});
```

ä½ å¯ä»¥ä½¿ç”¨ Fetch API æ”¯æŒçš„ä»»ä½•ç±»å‹çš„ Web æµä½œä¸ºæ¨¡æ‹Ÿçš„å“åº”ä½“ï¼Œæ¯”å¦‚ä¸€ä¸ª `TransformStream`ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªåœ¨è·å–åŸå§‹å“åº”æµå¹¶åœ¨å…¶å—ä¹‹é—´æ’å…¥å»¶è¿Ÿçš„å¤åˆåœºæ™¯ï¼Œä½¿ç”¨ `TransformStream`ï¼š

```js
import { http, HttpResponse, delay } from 'msw';

http.get('/video/:id', async ({ params }) => {
  const videoResponse = await fetch(
    `https://api.example.com/videos/${params.id}`
  );
  const videoStream = videoResponse.body;

  const latencyStream = new TransformStream({
    start() {},
    async transform(chunk, controller) {
      await delay(1000);
      controller.enqueue(chunk);
    },
  });

  return new HttpResponse(
    videoStream.pipeThrough(latencyStream),
    videoResponse
  );
});
```

### å“åº”æ—¶é—´

ä½ å¯ä»¥ä½¿ç”¨ MSW çš„ `delay()` å‡½æ•°æ¥æ§åˆ¶æ‹¦æˆªè¯·æ±‚æ—¶çš„æœåŠ¡å™¨å“åº”æ—¶é—´ã€‚åœ¨åº•å±‚ï¼Œ`delay()` å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªåœ¨ä¸€å®šæ—¶é—´åè§£å†³çš„ `promise`ã€‚

```js
import { http, HttpResponse, delay } from 'msw';

http.get('/resource', async () => {
  await delay(500);
  return HttpResponse.json({ id: 'abc-123' });
});
```

æ‚¨å¯ä»¥åœ¨å“åº”è§£æçš„ä»»ä½•æ—¶å€™ä½¿ç”¨ `delay()`ï¼ŒåŒ…æ‹¬åœ¨æµå¼å—ä¹‹é—´ï¼Œå¦‚æœ ä»¥æµæ–¹å¼å“åº”ï¼š

```js
http.get('/stream', () => {
  const stream = new ReadableStream({
    async start(controller) {
      controller.enqueue(new TextEncoder().encode('hello'))
      await delay(200)
      controller.enqueue(new TextEncoder().encode('world'))
      await delay(300)
      controller.close()
    },
  })

  return new HttpResponse(stream, { ... })
})
```

æœ‰æ—¶æ‚¨å¯èƒ½å¸Œæœ›å¼•å…¥å½±å“æ‰€æœ‰è¯·æ±‚ çš„å»¶è¿Ÿã€‚æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å®ç°

1.å»¶è¿Ÿç©¿é€å¤„ç†ç¨‹åºï¼šåˆ©ç”¨è¯·æ±‚å¤„ç†ç¨‹åºçš„æ‰§è¡Œé¡ºåºï¼Œæ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤„ç†ç¨‹åºï¼Œåªç­‰å¾…ä¸€ä¸ªå»¶è¿Ÿ åœ¨ å…¶ä»–å¤„ç†ç¨‹åºä¹‹å‰

```js
export const handlers = [
  http.all('*', async () => {
    await delay(500);
  }),

  // ...other request handlers.
];
```

2. é«˜é˜¶è§£æå™¨ï¼šå¦ä¸€ç§é€‰æ‹©æ˜¯å®šä¹‰ä¸€ä¸ª é«˜é˜¶å“åº”è§£æå™¨ï¼Œå®ƒå°è£…å»¶è¿Ÿé€»è¾‘ï¼Œå¹¶æœ‰é€‰æ‹©åœ°å°†å…¶åº”ç”¨äºæŸäº›å“åº”è§£æå™¨

```js
import { delay, type HttpResponseResolver } from 'msw';

export async function withDelay(resolver: HttpResponseResolver) {
  return async (...args) => {
    // Provide no arguments to the `delay` function
    // to apply a random realistic response time.
    await delay();
    return resolver(...args);
  };
}
```

ç„¶åï¼Œä½ å¯ä»¥åœ¨è¯·æ±‚å¤„ç†ç¨‹åºä¸­ä½¿ç”¨ `withDelay()` å‡½æ•°åŒ…è£…å“åº”è§£æå™¨ï¼š

```js
import { withDelay } from './with-delay';

export const handlers = [
  http.get(
    '/user',
    withDelay(({ request }) => {
      return HttpResponse.json({ id: 'abc-123' });
    })
  ),
  http.post(
    '/cart/:cartId',
    withDelay(() => {
      return new HttpResponse(null, { status: 201 });
    })
  ),
  http.get('/products', () => {
    return HttpResponse.json([1, 2, 3]);
  }),
];
```

::: tip éšå¼å»¶è¿Ÿ
å½“ä¸å¸¦ä»»ä½•å‚æ•°è°ƒç”¨æ—¶ï¼Œdelay å‡½æ•°ä¼šåº”ç”¨ä¸€ä¸ª çœŸå®çš„æœåŠ¡å™¨å“åº”æ—¶é—´ã€‚å®ƒæ˜¯ä¸€ä¸ªéšæœºæ•°ï¼Œç­‰äºä½ åœ¨ä¸å®é™… HTTP æœåŠ¡å™¨é€šä¿¡æ—¶é‡åˆ°çš„å¹³å‡å“åº”æ—¶é—´ï¼ˆå¤§çº¦ 100-400 æ¯«ç§’ï¼‰ã€‚
:::

::: tip å»¶è¿Ÿæ¨¡å¼

MSW æä¾›äº†ä¸¤ç§å»¶è¿Ÿæ¨¡å¼ï¼š

- "real"ï¼šæ˜ç¡®è®¾ç½®é€¼çœŸå“åº”æ—¶é—´ï¼›
- "infinite"ï¼Œæ— é™æœŸå»¶è¿Ÿå“åº”ï¼Œä½¿å…¶æ°¸è¿œæ‚¬è€Œæœªå†³

:::

### æ–‡ä»¶ä¸Šä¼ 

ç½‘é¡µä¸Šçš„æ–‡ä»¶ä¸Šä¼ é€šå¸¸é€šè¿‡æäº¤ä¸€ä¸ª POST è¯·æ±‚ï¼Œå¹¶åœ¨ FormData ä½“ä¸­åŒ…å«æ–‡ä»¶ã€‚ä½ å¯ä»¥æ‹¦æˆªè¯¥è¯·æ±‚ï¼Œå¹¶ä½¿ç”¨æ‹¦æˆªçš„ Fetch API Request å®ä¾‹ä¸Šçš„ formData() æ–¹æ³•è¯»å–å…¶ä¸»ä½“ä¸º FormDataã€‚

```js
import { http, HttpResponse } from 'msw';

export const handlers = [
  http.post('/upload', async ({ request }) => {
    const data = await request.formData();
    const file = data.get('file');

    if (!file) {
      return new HttpResponse('Missing document', { status: 400 });
    }

    if (!(file instanceof File)) {
      return new HttpResponse('Uploaded document is not a File', {
        status: 400,
      });
    }

    return HttpResponse.json({
      contents: await file.text(),
    });
  }),
];
```

æ‚¨å¯ä»¥ä»¥ä»»ä½•æ‚¨å–œæ¬¢çš„æ–¹å¼ä¸Šä¼ æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨ `JavaScript`ä¸­çš„`fetch()`å‡½æ•°å°†çº¯æ–‡æœ¬`doc.txt`æ–‡æ¡£ å‘é€åˆ°æœåŠ¡å™¨çš„ç¤ºä¾‹

```js
const data = new FormData();
const file = new Blob(['Hello', 'world'], { type: 'text/plain' });
data.set('file', file, 'doc.txt');

fetch('/upload', {
  method: 'POST',
  body: data,
});
```

### ä»£ç†è¯·æ±‚

æ‚¨å¯ä»¥é€šè¿‡æ„å»ºä»£ç†`Fetch API Request`å®ä¾‹å¹¶ä½¿ç”¨`bypass()`å‡½æ•°æ‰§è¡Œå®ƒæ¥ä»£ç†æ‹¦æˆªçš„è¯·æ±‚ï¼Œä»¥é˜²æ­¢å®ƒå†æ¬¡åŒ¹é…åŒä¸€è¯·æ±‚å¤„ç†ç¨‹åºã€‚è¿™å¯ä»¥å°†æ‚¨çš„ MSW è®¾ç½®å˜æˆå½±å“æœ¬åœ°å’Œå¤–éƒ¨æµé‡çš„ä»£ç†æœåŠ¡å™¨ã€‚

```js
import { http, bypass } from 'msw';

export const handlers = [
  http.get('/resource', async ({ request }) => {
    const originalUrl = new URL(request.url);

    // Modify the original URL to point to a different server.
    originalUrl.hostname = 'api.example.com';

    // Construct a proxy request.
    const proxyRequest = new Request(proxyUrl, {
      headers: {
        'content-type': request.headers.get('Content-Type'),
        'x-proxy-header': 'abc-123',
      },
    });

    // Perform the proxy request.
    const originalResponse = await fetch(bypass(proxyRequest));

    // Continue handling the request...
  }),
];
```

### å“åº”ä¿®è¡¥

ä½ å¯ä»¥ç»“åˆåŸå§‹å“åº”å’Œæ¨¡æ‹Ÿå“åº”ï¼Œä½¿ç”¨ä¸€ç§ç§°ä¸º å“åº”ä¿®è¡¥ çš„æŠ€æœ¯ã€‚å®ƒæ¶‰åŠæŒ‰åŸæ ·æ‰§è¡Œè¢«æ‹¦æˆªçš„è¯·æ±‚ï¼Œè·å–å…¶åŸå§‹å“åº”ï¼Œç„¶åæ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹
ä½¿ç”¨ `bypass()` å‡½æ•°ä» msw æ‰§è¡Œä»»ä½• `Fetch API Request`ï¼Œç»•è¿‡ä»»ä½•åŒ¹é…çš„è¯·æ±‚å¤„ç†ç¨‹åºï¼Œå¹¶é˜²æ­¢ç”±ä½ ä½¿ç”¨ `bypass()` çš„å¤„ç†ç¨‹åºå¼•èµ·çš„æ— é™å¾ªç¯

```js
import { http, HttpResponse, bypass } from 'msw';

http.get('/resource', async ({ request }) => {
  // Get the original JSON response from the server.
  const originalData = await fetch(bypass(request)).then((response) =>
    response.json()
  );

  return HttpResponse.json({
    // Combine the original data with the mocked data.
    ...originalData,
    id: 'mocked-id',
  });
});
```
