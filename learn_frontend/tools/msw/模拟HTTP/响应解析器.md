# å“åº”è§£æå™¨

[[toc]]

å“åº”è§£æå™¨æ˜¯è¯·æ±‚å¤„ç†æ‹¦æˆªå™¨çš„ç»„æˆéƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè´Ÿè´£å¤„ç†è¯·æ±‚è¿”å›å“åº”

## å“åº”è§£æå™¨çš„å‚æ•°

å“åº”è§£æå™¨æ˜¯ä¸€ä¸ªå‡½æ•°åŒ…å«å¦‚ä¸‹å‚æ•°ï¼š

| Property    | Type                                 | Description                                                                                             |
| ----------- | ------------------------------------ | ------------------------------------------------------------------------------------------------------- |
| `request`   | `Request`                            | Fetch API Request representation of the intercepted request.<br>è·å– API Request è¡¨ç¤ºè¢«æ‹¦æˆªè¯·æ±‚çš„å†…å®¹ã€‚ |
| `requestId` | `string`                             | UUID representing the intercepted request.<br>ä»£è¡¨è¢«æ‹¦æˆªè¯·æ±‚çš„ UUID                                     |
| `params`    | `Record<string, string \| string[]>` | Request path parameters (e.g. `:userId`).<br>è¯·æ±‚è·¯å¾„å‚æ•°ï¼ˆä¾‹å¦‚ `:userId`ï¼‰                             |
| `cookies`   | `Record<string, string>`             | Parsed request cookies.<br>è§£æçš„è¯·æ±‚ cookies.                                                          |

```js
http.get('/resource', ({ request, params, cookies }) => {});
```

## å¤„ç†è·¯å¾„å‚æ•°

### è·å–ä¸€èˆ¬è·¯å¾„å‚æ•°

ä½ å¯ä»¥é€šè¿‡åœ¨è¯·æ±‚å¤„ç†ç¨‹åºçš„è·¯å¾„ä¸­åŒ…å«å†’å·`:`åè·Ÿå‚æ•°åæ¥å®šä¹‰è·¯å¾„å‚æ•°

```js
//         ğŸ‘‡ describe parameter types
http.get < { id: string } > ('/posts/:id', () => {});
//
```

è·¯å¾„å‚æ•°è¡¨ç¤ºè¯·æ±‚ URL ä¸­çš„åŠ¨æ€éƒ¨åˆ†ï¼Œä¸ä¼šè¢«å­—é¢åŒ¹é…ã€‚ç›¸åï¼Œå‚æ•°ä½ç½®ä¸Šçš„ä»»ä½•å­—ç¬¦ä¸²éƒ½å°†å­˜å‚¨åœ¨å“åº”è§£æå™¨å‚æ•°ä¸­æš´éœ²çš„ `params` å¯¹è±¡ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡å“åº”è§£æå™¨å‚æ•°ä¸­çš„ params å¯¹è±¡è®¿é—®è·¯å¾„å‚æ•°çš„å€¼ã€‚

```js
http.get <
  { id: string } >
  ('/posts/:id',
  ({ params }) => {
    const { id } = params;
  });
```

### è·å–é‡å¤è·¯å¾„å‚æ•°

å°†åŠ å·ï¼ˆ`+`ï¼‰ç”¨ä½œè·¯å¾„å‚æ•°çš„åç¼€ï¼Œä»¥è¡¨ç¤ºå…¶å€¼é‡å¤ã€‚é‡å¤çš„è·¯å¾„å‚æ•°å°†åœ¨ `params` å¯¹è±¡ä¸­ä»¥å€¼æ•°ç»„çš„å½¢å¼è¡¨ç¤ºã€‚

```js
http.get<{ segments: string[] }>('/settings/:segments+', ({ params }) => {
  console.log(params.segments)
})
```

| Request URL                   | params.segments               |
| ----------------------------- | ----------------------------- |
| `/settings/user`              | `["user"]`                    |
| `/settings/user/privacy`      | `["user", "privacy"]`         |
| `/settings/user/profile/edit` | `["user", "profile", "edit"]` |

## å¤„ç†æŸ¥è¯¢å‚æ•°

### è¯»å–å•ä¸ªæŸ¥è¯¢å‚æ•°

æ‚¨å¯ä»¥é€šè¿‡ä»`request.url`å­—ç¬¦ä¸²åˆ›å»º URL å¹¶è®¿é—®å…¶`searchParams`å±æ€§æ¥è¯»å–è¯·æ±‚çš„æŸ¥è¯¢å‚æ•°ã€‚

```js
http.get('/product', ({ request }) => {
  const url = new URL(request.url);

  // Given a request url of "/product?id=1",
  // the `productId` will be a "1" string.
  const productId = url.searchParams.get('id');

  if (!productId) {
    return new HttpResponse(null, { status: 404 });
  }

  return HttResponse.json({ id: productId });
});
```

`url.searchParams` æ˜¯ `URLSearchParams` çš„ä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨åƒ `.get()` å’Œ `.getAll()` è¿™æ ·çš„æ–¹æ³•è·å–æŸ¥è¯¢å‚æ•°çš„å€¼ã€‚

### è¯»å–å¤šå€¼æŸ¥è¯¢å‚æ•°

`URLSearchParams.prototype.getAll()` æ–¹æ³•è·å–å¤šå€¼æŸ¥è¯¢å‚æ•°çš„å€¼åˆ—è¡¨ã€‚

```js
http.get('/products', ({ request }) => {
  const url = new URL(request.url);

  // Given a request url of "/products?id=1&id=2&id=3",
  // the `productIds` will be an array of ["1", "2", "3"].
  const productIds = url.searchParams.getAll('id');
});
```

### å†™å…¥æŸ¥è¯¢å‚æ•°

è™½ç„¶ request å¯¹è±¡ä»£è¡¨ä¸€ä¸ªå·²ç»å‘ç”Ÿçš„ Fetch API è¯·æ±‚ ï¼Œä¸”æ— æ³•æ›´æ”¹ï¼Œä½†ä½ ä»ç„¶å¯ä»¥æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤å…¶æŸ¥è¯¢å‚æ•°ï¼Œå¦‚æœä½ å¸Œæœ› å°†è¯¥è¯·æ±‚è½¬å‘åˆ°å…¶ä»–åœ°æ–¹ã€‚

```js
http.get('/user', ({ request }) => {
  const url = new URL(request.url);
  url.searchParams.set('id', 'another-id');

  // Create a proxy request that extends the intercepted request
  // but has modified query parameters in its URL.
  const proxyRequest = new Request(url, request);
});
```

## å¤„ç†è¯·æ±‚ä½“

æ‚¨å¯ä»¥åƒé€šå¸¸è¯»å–ä»»ä½• Fetch API è¯·æ±‚ä¸€æ ·è¯»å–æˆªè·çš„è¯·æ±‚ä½“ã€‚åœ¨å“åº”è§£æå™¨å‚æ•°ä¸­è·å¾—çš„è¯·æ±‚å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¸¸è§„çš„è¯·æ±‚å®ä¾‹ï¼Œå¹¶ä¸”å¯ä»¥æŒ‰æ­¤æ“ä½œã€‚
ä¾‹å¦‚ï¼Œä½ å¯ä»¥è°ƒç”¨ `await request.json()` æ¥å°†è¯·æ±‚çš„æ­£æ–‡ä½œä¸º JSON è¯»å–ï¼Œ

```js
http.post < { id: string },
  Post >
    ('/posts/:id',
    async ({ request }) => {
      const newPost = await request.clone().json(); // Post
    });
```

::: warning æ³¨æ„
å¼ºçƒˆå»ºè®®åœ¨è¯»å–æ‹¦æˆªè¯·æ±‚çš„ body ä¹‹å‰å…ˆ å…‹éš† ä¸€ä»½è¯·æ±‚ã€‚è™½ç„¶å¦‚æœä½ æ‰“ç®—æ¨¡æ‹Ÿå“åº”ï¼Œç›´æ¥è¯»å–è¯·æ±‚ä½“æ˜¯å¯ä»¥çš„ï¼Œä½†åœ¨ `passthrough`ç»•è¿‡åœºæ™¯ä¸­ä¸è¿›è¡Œå…‹éš†å°±è¯»å–è¯·æ±‚ä½“ä¼šå¯¼è‡´å¼‚å¸¸ï¼ˆæµä¸èƒ½è¢«é‡å¤è¯»å–ï¼‰ã€‚å¯¹äºå…¶ä»–æ–¹æ³•ï¼Œå¦‚ `.text()ã€.formData()ã€.blob()` ç­‰ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚
:::

## å¤„ç† Cookies

æ‚¨å¯ä»¥é€šè¿‡å“åº”è§£æå™¨å‚æ•°ä¸­æä¾›ç»™æ‚¨çš„ `cookie` å¯¹è±¡è¯»å–è¯·æ±‚çš„ `cookie`ã€‚è™½ç„¶æ‚¨æ€»æ˜¯å¯ä»¥æ‰‹åŠ¨è¯»å– `request.headers.getï¼ˆ'cookie'ï¼‰`ï¼Œä½†ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ`cookie` å¯¹è±¡ä¼šä¸ºæ‚¨è§£æè¯·æ±‚ `cookie`ã€‚

```js
http.get('/api/user', ({ cookies }) => {
  if (!cookies.authToken) {
    return new HttpResponse(null, { status: 403 });
  }

  return HttpResponse.json({ name: 'John' });
});
```

## æ¨¡æ‹Ÿå“åº”

### å“åº”çš„ä¸‰éƒ¨åˆ†

1. å“åº”çŠ¶æ€ç ï¼šHTTP çŠ¶æ€ç ï¼Œå¦‚ 200ã€404ã€500 ç­‰

```js
http.get('/resource', () => {
  return new HttpResponse(null, { status: 404 });
});
```

2. å“åº”å¤´

```js
http.get('/resource', () => {
  return HttpResponse.json(
    { id: 'abc-123' },
    {
      headers: {
        'content-type': 'application/hal+json',
      },
    }
  );
});
```

3. å“åº”ä½“

ä½ å¯ä»¥ä½¿ç”¨æ‰€æœ‰æ”¯æŒçš„å“åº”ä½“ç±»å‹ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²ã€`Blobã€ArrayBufferã€FormDataã€URLSearchParams` å’Œ `ReadableStream` ä½œä¸ºæ¨¡æ‹Ÿå“åº”çš„æ­£æ–‡ã€‚

```js
http.get('/resource', () => {
  return HttpResponse.text('hello world');
});
```

### è¿”å›åŸå§‹å“åº”-passthrough

ä½ å¯ä»¥æŒ‰åŸæ ·æ‰§è¡Œè¢«æ‹¦æˆªçš„è¯·æ±‚ï¼Œå¹¶è¿”å›å…¶åŸå§‹å“åº”ï¼ˆå³é€ä¼ è¯·æ±‚ï¼‰ï¼Œæ–¹æ³•æ˜¯è¿”å› `passthrough()`å‡½æ•°è°ƒç”¨çš„ç»“æœ

```js
import { passthrough } from 'msw';

http.get('/resource', () => {
  return passthrough();
});
```

å½“ä½ åªæƒ³åœ¨ç‰¹å®šæƒ…å†µä¸‹æ¨¡æ‹Ÿå“åº”ï¼Œè€Œåœ¨å…¶ä»–æƒ…å†µä¸‹æŒ‰åŸæ ·æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œè¿™å°¤å…¶æœ‰ç”¨ã€‚

```js
http.get('https://api.example.com/resource', async ({ request }) => {
  const data = await request.clone().json();

  if (data?.id === 'abc-123') {
    return HttpResponse.json({ id: 'abc-123' });
  }

  return passthrough();
});
```

### ä¸è¿”å›ä»»ä½•å†…å®¹

æ‚¨ä¹Ÿå¯ä»¥æ˜¾å¼æˆ–éšå¼åœ°ä»å“åº”è§£æå™¨ä¸­ä¸è¿”å›ä»»ä½•å†…å®¹ã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼ŒMSW å°†ç»§ç»­å¯»æ‰¾å¯èƒ½åŒ¹é…æ­¤è¯·æ±‚çš„å…¶ä»–è¯·æ±‚å¤„ç†ç¨‹åºã€‚æ‚¨å¯ä»¥å°†å…¶ç”¨äºç½‘ç»œè‡ªæ£€æˆ–ä»»ä½•å…¶ä»–ä¸æ¶‰åŠå“åº”è¯·æ±‚çš„å‰¯ä½œç”¨ã€‚

```js
export const handlers = [
  http.get('/resource', ({ request }) => {
    console.log('Request intercepted!', request.method, request.url);
  }),
  http.get('/resource', () => {
    return HttpResponse.text('hello world');
  }),
];
```

è§£é‡Šï¼šåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚å¤„ç†ç¨‹åºå°†ä¼šåŒ¹é…ï¼Œè®°å½•æ¶ˆæ¯åˆ°æ§åˆ¶å°ï¼Œå¹¶ä¸”ç”±äºå®ƒæ²¡æœ‰è¿”å›ä»»ä½•å†…å®¹ï¼Œå¤„ç†ç»“æŸã€‚ç„¶åï¼Œç¬¬äºŒä¸ªè¯·æ±‚å¤„ç†ç¨‹åºå°†ä¼šåŒ¹é…åŒæ ·çš„è¯·æ±‚ï¼Œå¹¶ç”¨ä¸€ä¸ªæ¨¡æ‹Ÿçš„å“åº”æ¥å¤„ç†å®ƒï¼Œä½œä¸ºä¸€ä¸ªç¤ºä¾‹ã€‚
