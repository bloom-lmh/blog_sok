# 起步

[[toc]]

## 简介

jest 是 Facebook 推出的 JavaScript 测试框架，它可以用来测试 JavaScript 代码的行为是否符合预期。

## 安装 jest

使用 npm 或 yarn 安装 jest：

::: code-group

```bash [js版本]
# js版本
npm install --save-dev jest
# 或
yarn add --dev jest
```

```bash [ts版本]
# ts版本
npm install --save-dev ts-jest @types/jest typescript
# 或
yarn add --dev  ts-jest @types/jest typescript
```

:::

## 配置启动脚本

`package.json`中添加启动脚本：

```json
{
  "scripts": {
    // jest是默认的命令，后面可以接参数
    "test": "jest"
  }
}
```

::: tip 常用的命令参数

- ​ 进入监视模式：`jest --watch`
- 只运行匹配名称的测试：`jest -t "测试名称"`

更多参数请见[官网](https://jestjs.io/docs/cli)和具体章节

:::

## 兼容 ES6 语法

jest 和 ts-jest 默认不支持 ES6 语法，需通过 `Babel` 来将 ES6 语法转译成 `CommonJS` 格式。

1. 安装 `Babel` 和相关插件：`npm install --save-dev babel-jest @babel/core @babel/preset-env`

::: tip 解释 babel-jest
`babel-jest` 是 Jest 的 Babel 集成插件，会自动处理 `.js/.jsx/.ts` 等文件
:::

2. Babel 基础配置：创建 `babel.config.js` 文件，指定针对当前 Node 版本的编译规则

```js
module.exports = {
  presets: [['@babel/preset-env', { targets: { node: 'current' } }]],
};
```

::: tip 解释 `@babel/preset-env`
`@babel/preset-env` 提供智能语法降级，`node: 'current'` 确保不转译当前 Node 已原生支持的语法，提升测试速度
:::

::: tip jest 环境变量
Jest 运行时会自动设置 `process.env.NODE_ENV = 'test'`，可通过 Babel 的 `api.env()` 区分测试环境和生成环境，因为测试环境和生成环境的 nodejs 版本可能不同，导致语法不同。下面是更高级的配置：

```js
// babel.config.js
module.exports = (api) => {
  const isTest = api.env('test');
  const isProd = api.env('production');

  return {
    presets: [
      [
        '@babel/preset-env',
        {
          targets: isTest ? { node: 'current' } : '> 0.25%, not dead',
          modules: isTest ? 'commonjs' : false, // 测试环境转 CJS，生产环境保留 ESM
        },
      ],
    ],
    plugins: isProd ? ['transform-remove-console'] : [], // 生产环境移除 console
  };
};
```

:::

## 兼容 Typescript

### 使用 Babel

Jest 支持 TypeScript，通过 Babel。首先，确保你已按照使用 Babel 上的指示操作。接下来

1. 安装 @babel/preset-typescript：`npm install --save-dev @babel/preset-typescript`
2. 配置 `babel.config.js`：然后将 @babel/preset-typescript 添加到你的 babel.config.js 的预设列表中

```js {4}
module.exports = {
  presets: [
    ['@babel/preset-env', { targets: { node: 'current' } }],
    '@babel/preset-typescript',
  ],
};
```

### 使用 ts-jest

Jest 官方推荐的方案是使用 `ts-jest`，它可以自动处理 TypeScript 代码，并提供类型检查，而不再需要安装额外的 Babel 配置来支持 ts。但是 ES6 语法的支持仍然需要通过 Babel 来实现。

安装：`npm install --save-dev ts-jest @types/jest typescript`

## 配合打包工具

jest 可以与打包工具结合使用，如 `webpack、rollup、parcel` 等。所谓的配合打包工具其实就是使用打包工具集成 `babel`和 Typescript 来帮助 jest 处理 ES6 语法、TypeScript 和降级工作。

### webpack 集成

安装：`npm install --save-dev jest webpack webpack-cli babel-jest @babel/core @babel/preset-env ts-loader`

- jest:jest 测试框架
- webpack: webpack 打包工具
- webpack-cli: webpack 命令行工具
- babel-jest: jest 的 babel 集成插件
- @babel/core: babel 核心库
- @babel/preset-env: babel 预设环境
- ts-loader: webpack 的 ts 加载器,当然也可以使用`@babel/preset-typescript`，但是这个 babel 插件没有 ts 类型检查等功能

配置示例：​

```js
// webpack.config.js
module.exports = {
  module: {
    rules: [
      {
        test: /\.ts$/,
        exclude: /node_modules/,
        use: [
          {
            loader: 'babel-loader',
          },
          {
            loader: 'ts-loader',
          },
        ],
      },
    ],
  },
};
```

::: tip 关于 ts-loader 和 babel-loader
当遇到 ts 文件时，会先经过 ts-loader，然后再经过 babel-loader
ts-loader 会将 ts 编译成 js，babel-loader 会将 js 降级成 es5，jest 可以识别 es5 语法。
babel-laoder 流程如下：
![babel-laoder](https://image-bucket-1307756649.cos.ap-chengdu.myqcloud.com/image/a.png)
:::

### vite 集成

Jest 不被 Vite 支持，因为与 Vite 插件系统存在不兼容问题，如果要使用 Vite 配合 Jest，需要使用 `babel`来进行模块化处理
当然也可以使用 vite 原生测试框架 `vitest`

```js
export const presets = [
  ['@babel/preset-env', { targets: { node: 'current' } }], // 转换为当前 Node.js 版本支持的语法
];
```
