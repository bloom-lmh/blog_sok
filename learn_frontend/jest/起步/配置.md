# 配置

[[toc]]

## 基本介绍

jest 支持使用配置文件来决定 jest 的行为。使用如下命令可以初始化配置文件 `jest.config.js`:

```bash
npm init jest@latest
```

## 基础配置

### 测试文件匹配规则

```js
module.exports = {
  // 匹配测试文件（默认值）
  testMatch: ['**/__tests__/**/*.[jt]s?(x)', '**/?(*.)+(spec|test).[jt]s?(x)'],

  // 可添加自定义匹配规则
  testRegex: '(/__tests__/.*|(\\.|/)(test|spec))\\.[jt]sx?$',
};
```

### 模块解析规则

```js
module.exports = {
  moduleFileExtensions: ['js', 'jsx', 'json', 'ts'], // 可识别扩展名

  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1', // 别名配置
    '\\.(css|less)$': 'identity-obj-proxy', // 模拟CSS模块
  },
};
```

## 测试环境配置

### 测试环境选择

```js
module.exports = {
  testEnvironment: 'jsdom', // 浏览器环境
  // 或
  testEnvironment: 'node', // Node环境

  // 自定义环境（需继承 jest-environment-node）
  testEnvironment: '<rootDir>/custom-test-env.js',
};
```

### 测试启动文件

```js
module.exports = {
  setupFiles: ['<rootDir>/jest.setup.js'], // 每个测试文件执行前加载
  setupFilesAfterEnv: ['<rootDir>/jest.setupAfterEnv.js'], // Jest环境初始化后加载
  globalSetup: '<rootDir>/global-setup.js', // 全局测试前执行
  globalTeardown: '<rootDir>/global-teardown.js', // 全局测试后执行
};
```

## 覆盖率配置

```js
module.exports = {
  collectCoverage: true, // 开启覆盖率
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts}',
    '!**/node_modules/**',
    '!**/vendor/**',
  ],
  coverageDirectory: '<rootDir>/coverage', // 输出目录
  coverageThreshold: {
    // 覆盖率阈值
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
  coverageReporters: ['html', 'text-summary'], // 报告格式
};
```

## 转译与编译

### TypeScript 支持

```js
module.exports = {
  preset: 'ts-jest',
  transform: {
    '^.+\\.tsx?$': 'ts-jest',
  },
};
```

### Babel 集成

```js
module.exports = {
  transform: {
    '^.+\\.jsx?$': 'babel-jest',
  },
  transformIgnorePatterns: ['/node_modules/(?!(lodash-es|your-es-module)/)'],
};
```

## 性能优化配置

```js
module.exports = {
  // 并行测试配置
  maxWorkers: '50%', // 使用50% CPU核心
  maxConcurrency: 5, // 最大并行测试数

  // 缓存配置
  cacheDirectory: '/tmp/jest_cache',
  clearMocks: true, // 是否自动清理mock

  // 测试超时
  testTimeout: 5000, // 单个测试超时时间(ms)
};
```
