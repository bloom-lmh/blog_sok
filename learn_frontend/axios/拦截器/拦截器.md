# è¯·æ±‚æ‹¦é“¾

[[toc]]

## æ‹¦æˆªå™¨çš„åŸºæœ¬ä½¿ç”¨

ä½¿ç”¨ä½ å¯ä»¥åœ¨è¯·æ±‚æˆ–å“åº”è¢« `then` æˆ– `catch` å¤„ç†ä¹‹å‰æ‹¦æˆªå®ƒä»¬ã€‚æ‹¦æˆªå™¨æœ¬è´¨å°±æ˜¯èŒè´£é“¾æ¨¡å¼çš„ä¸€ç§å®ç°ã€‚

### æ·»åŠ è¯·æ±‚/å“åº”æ‹¦æˆªå™¨

```js
// Add a request interceptor
axios.interceptors.request.use(
  function (config) {
    // Do something before request is sent
    return config;
  },
  function (error) {
    // Do something with request error
    return Promise.reject(error);
  }
);

// Add a response interceptor
axios.interceptors.response.use(
  function (response) {
    // Any status code that lie within the range of 2xx cause this function to trigger
    // Do something with response data
    return response;
  },
  function (error) {
    // Any status codes that falls outside the range of 2xx cause this function to trigger
    // Do something with response error
    return Promise.reject(error);
  }
);
```

### ç§»é™¤è¯·æ±‚/å“åº”æ‹¦æˆªå™¨

```js
const myInterceptor = axios.interceptors.request.use(function (config) {
  // Do something before request is sent
  return config;
});

// Sometime later...
axios.interceptors.request.eject(myInterceptor);
```

## æ‹¦æˆªå™¨é“¾

### è®¾ç½®å¤šä¸ªæ‹¦æˆªå™¨

æ‹¦æˆªå™¨å¯ä»¥è®¾ç½®å¤šä¸ªï¼Œå¹¶ä¸”å…¨å±€æ‹¦æˆªå™¨å’Œå®ä¾‹æ‹¦æˆªå™¨å¯ä»¥ä¸€åŒå·¥ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```js
// å…¨å±€å“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use((response) => {
  console.log('å…¨å±€å“åº”æ‹¦æˆªå™¨1');
  response.data.globalMark = true;
  return response;
});
axios.interceptors.request.use((config) => {
  console.log('å…¨å±€å“åº”æ‹¦æˆªå™¨1');
  return config;
});
// å®ä¾‹å“åº”æ‹¦æˆªå™¨
instance.interceptors.response.use((response) => {
  console.log('å®ä¾‹å“åº”æ‹¦æˆªå™¨');
  response.data.instanceMark = true;
  return response;
});
```

### å¤šä¸ªæ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåº

ä¸åŒç±»å‹æ··åˆæ—¶ï¼šå…¨å±€è¯·æ±‚æ‹¦æˆªå™¨ â†’ å®ä¾‹è¯·æ±‚æ‹¦æˆªå™¨ â†’ å‘é€è¯·æ±‚æ¥æ”¶å“åº” â†’ å®ä¾‹å“åº”æ‹¦æˆªå™¨ â†’ å…¨å±€å“åº”æ‹¦æˆªå™¨

```js
// å…¨å±€æ‹¦æˆªå™¨
axios.interceptors.request.use((config) => {
  console.log('ğŸŒ å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨');
  return config;
});

axios.interceptors.response.use((response) => {
  console.log('ğŸŒ å…¨å±€å“åº”æ‹¦æˆªå™¨');
  return response;
});

// å®ä¾‹æ‹¦æˆªå™¨
const api = axios.create();

api.interceptors.request.use((config) => {
  console.log('ğŸ“± å®ä¾‹è¯·æ±‚æ‹¦æˆªå™¨');
  return config;
});

api.interceptors.response.use((response) => {
  console.log('ğŸ“± å®ä¾‹å“åº”æ‹¦æˆªå™¨');
  return response;
});

// å‘èµ·è¯·æ±‚
api.get('/test');

// è¾“å‡ºé¡ºåºï¼š
// ğŸŒ å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨
// ğŸ“± å®ä¾‹è¯·æ±‚æ‹¦æˆªå™¨
// ğŸ“± å®ä¾‹å“åº”æ‹¦æˆªå™¨
// ğŸŒ å…¨å±€å“åº”æ‹¦æˆªå™¨
```

åŒä¸€ç±»å‹ï¼š

```js
const api = axios.create();

// æ·»åŠ å¤šä¸ªè¯·æ±‚æ‹¦æˆªå™¨
api.interceptors.request.use((config) => {
  console.log('ğŸ”§ è¯·æ±‚æ‹¦æˆªå™¨A');
  config.headers['X-A'] = 'A';
  return config;
});

api.interceptors.request.use((config) => {
  console.log('ğŸ”§ è¯·æ±‚æ‹¦æˆªå™¨B');
  config.headers['X-B'] = 'B';
  return config;
});

api.interceptors.request.use((config) => {
  console.log('ğŸ”§ è¯·æ±‚æ‹¦æˆªå™¨C');
  config.headers['X-C'] = 'C';
  return config;
});

// æ·»åŠ å¤šä¸ªå“åº”æ‹¦æˆªå™¨
api.interceptors.response.use((response) => {
  console.log('âœ… å“åº”æ‹¦æˆªå™¨X');
  return response;
});

api.interceptors.response.use((response) => {
  console.log('âœ… å“åº”æ‹¦æˆªå™¨Y');
  return response;
});

api.interceptors.response.use((response) => {
  console.log('âœ… å“åº”æ‹¦æˆªå™¨Z');
  return response;
});

api.get('/test');

// å®Œæ•´è¾“å‡ºé¡ºåºï¼š
// ğŸ”§ è¯·æ±‚æ‹¦æˆªå™¨A
// ğŸ”§ è¯·æ±‚æ‹¦æˆªå™¨B
// ğŸ”§ è¯·æ±‚æ‹¦æˆªå™¨C
// âœ… å“åº”æ‹¦æˆªå™¨Z
// âœ… å“åº”æ‹¦æˆªå™¨Y
// âœ… å“åº”æ‹¦æˆªå™¨X
```

## æ‹¦æˆªå™¨ã€æ•°æ®è½¬æ¢å’Œè‡ªå®šä¹‰çŠ¶æ€çš„æ‰§è¡Œé¡ºåº

å½“æ‹¦æˆªå™¨ã€æ•°æ®è½¬æ¢å’Œè‡ªå®šä¹‰çŠ¶æ€åœ¨ä¸€èµ·æ—¶ï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š

```js
// 1. å…¨å±€é…ç½®
axios.defaults.validateStatus = (status) => {
  console.log(`ğŸ” validateStatus: ${status}`);
  return status < 500; // 4xx ä»¥ä¸‹è§†ä¸ºæˆåŠŸ
};

// 2. å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨
axios.interceptors.request.use((config) => {
  console.log('ğŸŒ å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨');
  return config;
});

// 3. å…¨å±€å“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(
  (response) => {
    console.log('ğŸŒ å…¨å±€å“åº”æ‹¦æˆªå™¨');
    return response;
  },
  (error) => {
    console.log('ğŸŒ å…¨å±€é”™è¯¯æ‹¦æˆªå™¨');
    return Promise.reject(error);
  }
);

// 4. åˆ›å»ºå®ä¾‹
const api = axios.create({
  transformRequest: [
    (data) => {
      console.log('ğŸ”„ è¯·æ±‚è½¬æ¢1');
      return data;
    },
    (data) => {
      console.log('ğŸ”„ è¯·æ±‚è½¬æ¢2');
      return JSON.stringify(data);
    },
  ],
  transformResponse: [
    (data) => {
      console.log('ğŸ”„ å“åº”è½¬æ¢1');
      return data;
    },
    (data) => {
      console.log('ğŸ”„ å“åº”è½¬æ¢2');
      try {
        return JSON.parse(data);
      } catch {
        return data;
      }
    },
  ],
});

// 5. å®ä¾‹è¯·æ±‚æ‹¦æˆªå™¨
api.interceptors.request.use((config) => {
  console.log('ğŸ“± å®ä¾‹è¯·æ±‚æ‹¦æˆªå™¨');
  return config;
});

// 6. å®ä¾‹å“åº”æ‹¦æˆªå™¨
api.interceptors.response.use(
  (response) => {
    console.log('ğŸ“± å®ä¾‹å“åº”æ‹¦æˆªå™¨');
    return response;
  },
  (error) => {
    console.log('ğŸ“± å®ä¾‹é”™è¯¯æ‹¦æˆªå™¨');
    return Promise.reject(error);
  }
);

// 7. å‘èµ·è¯·æ±‚
api
  .post('/api/users', { name: 'John' })
  .then((response) => {
    console.log('âœ… æœ€ç»ˆå“åº”');
  })
  .catch((error) => {
    console.log('âŒ æœ€ç»ˆé”™è¯¯');
  });
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š
::: code-group

```bash [æˆåŠŸå“åº”æƒ…å†µ]
ğŸŒ å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨
ğŸ“± å®ä¾‹è¯·æ±‚æ‹¦æˆªå™¨
ğŸ”„ è¯·æ±‚è½¬æ¢1
ğŸ”„ è¯·æ±‚è½¬æ¢2
ğŸ” validateStatus: 200
ğŸ”„ å“åº”è½¬æ¢1
ğŸ”„ å“åº”è½¬æ¢2
ğŸ“± å®ä¾‹å“åº”æ‹¦æˆªå™¨
ğŸŒ å…¨å±€å“åº”æ‹¦æˆªå™¨
âœ… æœ€ç»ˆå“åº”
```

```bash [404 é”™è¯¯æƒ…å†µ]
ğŸŒ å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨
ğŸ“± å®ä¾‹è¯·æ±‚æ‹¦æˆªå™¨
ğŸ”„ è¯·æ±‚è½¬æ¢1
ğŸ”„ è¯·æ±‚è½¬æ¢2
ğŸ” validateStatus: 404
ğŸ”„ å“åº”è½¬æ¢1
ğŸ”„ å“åº”è½¬æ¢2
ğŸ“± å®ä¾‹å“åº”æ‹¦æˆªå™¨
ğŸŒ å…¨å±€å“åº”æ‹¦æˆªå™¨
âœ… æœ€ç»ˆå“åº” (å› ä¸º validateStatus è¿”å› true)
```

```bash [æœåŠ¡å™¨é”™è¯¯æƒ…å†µ]
ğŸŒ å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨
ğŸ“± å®ä¾‹è¯·æ±‚æ‹¦æˆªå™¨
ğŸ”„ è¯·æ±‚è½¬æ¢1
ğŸ”„ è¯·æ±‚è½¬æ¢2
ğŸ” validateStatus: 500
ğŸ“± å®ä¾‹é”™è¯¯æ‹¦æˆªå™¨
ğŸŒ å…¨å±€é”™è¯¯æ‹¦æˆªå™¨
âŒ æœ€ç»ˆé”™è¯¯
```

:::

## æœ€ä½³å®è·µ

æ‹¦æˆªå™¨é€šå¸¸ç”¨æ¥åšå¦‚ä¸‹å·¥ä½œï¼š

### ç»Ÿä¸€èº«ä»½è®¤è¯

```js
// æ·»åŠ å…¨å±€Token
axios.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

ä½œç”¨ â€‹ï¼šè‡ªåŠ¨ä¸ºæ‰€æœ‰è¯·æ±‚æ·»åŠ  JWT ç­‰è®¤è¯ä¿¡æ¯
åœºæ™¯ â€‹ï¼šç”¨æˆ·ç™»å½•çŠ¶æ€ç»´æŠ¤ã€API æƒé™æ§åˆ¶

### å…¨å±€é”™è¯¯å¤„ç†

```js
axios.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response.status === 401) {
      router.push('/login'); // è·³è½¬åˆ°ç™»å½•é¡µ
    }
    return Promise.reject(error);
  }
);
```

ä½œç”¨ â€‹ï¼šé›†ä¸­å¤„ç† HTTP é”™è¯¯ç ï¼ˆå¦‚ 401/404/500ï¼‰
åœºæ™¯ â€‹ï¼šç»Ÿä¸€å¼¹çª—æç¤ºã€ç™»å½•è¿‡æœŸè·³è½¬

### è¯·æ±‚é˜²æŠ–

```js
const pendingRequests = new Map();
axios.interceptors.request.use((config) => {
  const key = `${config.method}-${config.url}`;
  if (pendingRequests.has(key)) {
    pendingRequests.get(key).abort(); // å–æ¶ˆé‡å¤è¯·æ±‚
  }
  const controller = new AbortController();
  config.signal = controller.signal;
  pendingRequests.set(key, controller);
  return config;
});

axios.interceptors.response.use((response) => {
  const key = `${response.config.method}-${response.config.url}`;
  pendingRequests.delete(key);
  return response;
});
```

ä½œç”¨ â€‹ï¼šé˜²æ­¢é‡å¤æäº¤
åœºæ™¯ â€‹ï¼šè¡¨å•æäº¤ã€é«˜é¢‘æŸ¥è¯¢
