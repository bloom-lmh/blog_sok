# 自定义相关

[[toc]]

## 适配器-adapter

1. 作用 ​：自定义请求的适配器（`Adapter`），用于覆盖 `Axios` 默认的 `HTTP` 请求处理逻辑。
2. 使用场景 ​：
   - 修改默认的请求发送方式（例如替换浏览器端的 `XMLHttpRequest` 或 `Node.js` 端的 `http` 模块）。
   - 实现 `Mock` 数据（测试时拦截请求并返回模拟数据）。
   - 自定义缓存逻辑、请求重试等高级功能。

### Mock 数据

```js
import axios, { AxiosAdapter } from 'axios';

// 1. 自定义 Mock 适配器
const mockAdapter: AxiosAdapter = (config) => {
  // 根据请求 URL 返回不同的模拟数据
  if (config.url?.includes('/user')) {
    return Promise.resolve({
      data: { id: 1, name: 'Mock User' },
      status: 200,
      headers: {},
      config
    });
  }
  // 其他请求走默认逻辑
  return axios.defaults.adapter!(config);
};

// 2. 使用适配器
const api = axios.create({
  adapter: mockAdapter
});

// 3. 发起请求（返回 Mock 数据）
api.get('/user/1').then(response => {
  console.log(response.data); // { id: 1, name: 'Mock User' }
});
```

### 自定义缓存逻辑

对 GET 请求添加内存缓存，避免重复请求

```js
const cache = new Map<string, any>();

const cacheAdapter: AxiosAdapter = async (config) => {
  // 仅缓存 GET 请求
  if (config.method?.toLowerCase() === 'get') {
    const cacheKey = JSON.stringify({ url: config.url, params: config.params });
    if (cache.has(cacheKey)) {
      return Promise.resolve(cache.get(cacheKey)); // 返回缓存
    }
    // 真实请求并缓存结果
    const response = await axios.defaults.adapter!(config);
    cache.set(cacheKey, response);
    return response;
  }
  // 其他请求走默认逻辑
  return axios.defaults.adapter!(config);
};

// 使用缓存适配器
const api = axios.create({ adapter: cacheAdapter });

// 第一次请求（调用真实接口并缓存）
api.get('/data').then(response => console.log('First:', response.data));

// 第二次相同请求（直接返回缓存）
setTimeout(() => {
  api.get('/data').then(response => console.log('Second (Cached):', response.data));
}, 1000);
```

### 请求重试机制

当请求失败时，自动重试最多 3 次。

```js
const retryAdapter: AxiosAdapter = async (config) => {
  const maxRetries = 3;
  let retryCount = 0;

  const tryRequest = async (): Promise<any> => {
    try {
      return await axios.defaults.adapter!(config);
    } catch (error) {
      if (retryCount >= maxRetries) throw error;
      retryCount++;
      console.log(`Retry ${retryCount}/${maxRetries} for ${config.url}`);
      return tryRequest(); // 递归重试
    }
  };

  return tryRequest();
};

// 使用重试适配器
const api = axios.create({ adapter: retryAdapter });

// 模拟失败请求（会重试 3 次）
api.get('http://example.com/unstable-api')
  .then(response => console.log('Success:', response.data))
  .catch(error => console.error('Final error:', error.message));
```
