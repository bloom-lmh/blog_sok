# 安全相关

[[toc]]

## 配置概览

安全相关的配置项如下：

```js
// 【认证】HTTP基础认证（会自动设置Authorization头）
auth: {
  username: 'janedoe',
  password: 's00pers3cret'
},
// 【跨域】是否携带凭据信息（如cookies）
withCredentials: false,
// 【安全】CSRF防护相关配置
xsrfCookieName: 'XSRF-TOKEN',  // CSRF token的cookie名
xsrfHeaderName: 'X-XSRF-TOKEN', // CSRF token的header名
```

## 基本认证-auth

auth 配置用于 HTTP 基本认证，它会将用户名和密码以 Base64 编码形式添加到请求头中。

```js
axios.get('/protected-data', {
  auth: {
    username: 'janedoe',
    password: 's00pers3cret',
  },
});
```

- 将 username:password 进行 Base64 编码
- 添加到请求头：Authorization: Basic <Base64 编码值>

## 是否携带凭据信息-withCredentials

在跨域请求中，默认情况下浏览器不会发送凭据信息（如 cookies）。这是出于安全考虑。但是，在某些需要身份验证的场景下，我们需要让跨域请求携带凭据信息，这时就需要设置 `withCredentials: true`。

::: tip 服务端需要设置
服务器必须设置 `Access-Control-Allow-Credentials: true`
不能使用 `Access-Control-Allow-Origin: *`，必须指定明确的域名
:::

## CSRF 防护配置-xsrf

CSRF（跨站请求伪造）防护是现代 Web 应用的重要安全措施，主要有下面几种防护方法（具体防护细节看网络章节的 CSRF 防护部分）：

- 使用 token
- 双 Cookie 验证

Axios 提供了双 Cookie 验证的内置支持,即配置下面两项：

- `xsrfCookieName`: 'XSRF-TOKEN',
- `xsrfHeaderName`: 'X-XSRF-TOKEN',

当配置了这两项后，Axios 会自动去名为'XSRF-TOKEN'的 cookie 中读取 token 值，并在请求头中添加 `X-XSRF-TOKEN` 字段，值为读取的 token 值。示例如下所示：
::: code-group

```js [后端实现 (Node.js/Express)]
const express = require('express');
const cookieParser = require('cookie-parser');
const cors = require('cors');
const app = express();

app.use(cookieParser());
app.use(express.json());
app.use(
  cors({
    origin: 'http://your-frontend.com',
    credentials: true,
  })
);

// 设置CSRF Token Cookie
app.get('/csrf-token', (req, res) => {
  const token = crypto.randomBytes(32).toString('hex');
  res.cookie('XSRF-TOKEN', token, {
    httpOnly: false, // 允许前端读取
    secure: true,
    sameSite: 'Strict',
  });
  res.json({ message: 'CSRF Token已设置' });
});

// 验证CSRF Token
app.post('/api/data', (req, res) => {
  const cookieToken = req.cookies['XSRF-TOKEN'];
  const headerToken = req.headers['x-xsrf-token'];

  if (!cookieToken || cookieToken !== headerToken) {
    return res.status(403).json({ error: 'CSRF验证失败' });
  }

  res.json({ message: '请求成功', data: req.body });
});

app.listen(3000);
```

```js [前端实现 (Axios)]
import axios from 'axios';

// 配置Axios，自动携带CSRF Token
axios.defaults.xsrfCookieName = 'XSRF-TOKEN';
axios.defaults.xsrfHeaderName = 'X-XSRF-TOKEN';
// 必须开启withCredentials不然不会携带cookie
axios.defaults.withCredentials = true;

// 先获取CSRF Token
axios
  .get('http://your-api.com/csrf-token')
  .then(() => {
    // 然后发送受保护的请求
    return axios.post('http://your-api.com/api/data', { data: 'some data' });
  })
  .then((response) => {
    console.log('请求成功', response.data);
  })
  .catch((error) => {
    console.error('请求失败', error);
  });
```

:::
