# å‘å¸ƒè®¢é˜…æ¨¡å¼

[[toc]]

å‘å¸ƒè®¢é˜…æ¨¡å¼æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„æ‰©å±•

## è§‚å¯Ÿè€…æ¨¡å¼

è§‚å¯Ÿè€…æ¨¡å¼ï¼šè¢«è§‚å¯Ÿè€…æŒæœ‰è§‚å¯Ÿè€…çš„å¼•ç”¨ï¼Œå½“è¢«è§‚å¯Ÿè€…çŠ¶æ€å˜åŒ–æ—¶ï¼Œç›´æŽ¥é€šçŸ¥è§‚å¯Ÿè€…è¿›è¡Œæ›´æ–°ã€‚è€Œè§‚å¯Ÿè€…çš„æ›´æ–°æ˜¯åœ¨è¢«è§‚å¯Ÿè€…å†…éƒ¨è¿›è¡Œçš„ï¼Œè¢«è§‚å¯Ÿè€…ä¸Žè§‚å¯Ÿè€…è€¦åˆåœ¨ä¸€èµ·ã€‚
![è§‚å¯Ÿè€…æ¨¡å¼](https://image-bucket-1307756649.cos.ap-chengdu.myqcloud.com/image/20250707212454205.png)

```js
// è¢«è§‚å¯Ÿè€…ï¼ˆSubjectï¼‰
class Subject {
  constructor() {
    this.observers = [];
  }

  addObserver(observer) {
    this.observers.push(observer);
  }

  notify(data) {
    this.observers.forEach(observer => observer.update(data));
  }
}

// è§‚å¯Ÿè€…ï¼ˆObserverï¼‰
class Observer {
  update(data) {
    console.log(`æ”¶åˆ°æ•°æ®: ${data}`);
  }
}

// ä½¿ç”¨
const subject = new Subject();
const observer = new Observer();
subject.addObserver(observer);
subject.notify('Hello Observer!');
```

## å‘å¸ƒè®¢é˜…æ¨¡å¼

å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼šå‘å¸ƒè€…åªéœ€è¦å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯ä¸­å¿ƒå¯¹åº”é¢‘é“ï¼Œè®¢é˜…è€…ä»Žæ¶ˆæ¯ä¸­å¿ƒå¯¹åº”é¢‘é“å–æ¶ˆæ¯æ¶ˆè´¹å³å¯ã€‚å‘å¸ƒè€…å®Œå…¨ä¸å…³å¿ƒè°åœ¨è®¢é˜…ã€æ¶ˆæ¯å¦‚ä½•æ¶ˆè´¹ã€‚å‘å¸ƒè€…å’Œè®¢é˜…è€…é€šè¿‡æ¶ˆæ¯ä¸­å¿ƒè¿›è¡Œé€šä¿¡ï¼Œå®žçŽ°äº†å®Œå…¨è§£è€¦ã€‚å‘å¸ƒè®¢é˜…æ¨¡å¼æœ¬è´¨ä¸Šå°±æ˜¯ç”Ÿäº§-æ¶ˆè´¹æ¨¡åž‹çš„ä¸€ç§å®žçŽ°

![å‘å¸ƒè®¢é˜…æ¨¡å¼](https://image-bucket-1307756649.cos.ap-chengdu.myqcloud.com/image/20250707212640263.png)

```js
// æ¶ˆæ¯ä¸­å¿ƒï¼ˆBrokerï¼‰
class PubSub {
  constructor() {
    this.events = {};
  }

  subscribe(event, callback) {
    if (!this.events[event]) this.events[event] = [];
    this.events[event].push(callback);
  }

  publish(event, data) {
    if (!this.events[event]) return;
    this.events[event].forEach(cb => cb(data));
  }
}

// ä½¿ç”¨
const pubsub = new PubSub();

// è®¢é˜…è€…ï¼ˆæ— éœ€å›ºå®šæŽ¥å£ï¼‰
pubsub.subscribe('news', data => {
  console.log(`è®¢é˜…è€…1æ”¶åˆ°æ–°é—»: ${data}`);
});

// å¦ä¸€ä¸ªè®¢é˜…è€…
pubsub.subscribe('news', data => {
  console.log(`è®¢é˜…è€…2æ”¶åˆ°æ–°é—»: ${data}`);
});

// å‘å¸ƒè€…
pubsub.publish('news', 'Breaking News!');
```

## ä¸¤ç§æ¨¡å¼çš„åŒºåˆ«

æˆ‘ç”¨ä¸€ä¸ªå¤–å–ç³»ç»Ÿçš„ä¾‹å­ï¼Œå¸¦æ‚¨ç›´è§‚æ„Ÿå—ä¸¤è€…çš„åŒºåˆ«ï¼š

ðŸ” åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•åŽéœ€è¦

- å•†å®¶æŽ¥å•
- éª‘æ‰‹æŠ¢å•
- å‘é€çŸ­ä¿¡é€šçŸ¥

### æ–¹æ¡ˆ 1ï¼šè§‚å¯Ÿè€…æ¨¡å¼å®žçŽ°ï¼ˆæ— ä¸­é—´å•†ï¼‰

```bash
è§‚å¯Ÿè€…æ¨¡å¼ï¼š
[è®¢å•ä¸­å¿ƒ] â†’ ç›´æŽ¥è°ƒç”¨ â†’ [å•†å®¶æœåŠ¡]
       â†˜ï¸Ž â†’ ç›´æŽ¥è°ƒç”¨ â†’ [éª‘æ‰‹æœåŠ¡]
       â†˜ï¸Ž â†’ ç›´æŽ¥è°ƒç”¨ â†’ [çŸ­ä¿¡æœåŠ¡]
```

ä»£ç å®žçŽ°ï¼š

```js
// è®¢å•ä¸­å¿ƒï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰
class OrderSystem {
  constructor() {
    this.handlers = []; // å¿…é¡»ç»´æŠ¤æ‰€æœ‰å¤„ç†é€»è¾‘
  }

  // æ·»åŠ å¤„ç†é€»è¾‘ â†’ è€¦åˆç‚¹ï¼
  addHandler(handler) {
    this.handlers.push(handler);
  }

  // ä¸‹å• â†’ äº²è‡ªé€šçŸ¥æ‰€æœ‰äºº
  createOrder(order) {
    console.log('è®¢å•åˆ›å»ºæˆåŠŸ');
    this.handlers.forEach(handler => {
      handler.handleOrder(order); // è¦æ±‚æ‰€æœ‰handlerå®žçŽ°ç›¸åŒæŽ¥å£
    });
  }
}

// å•†å®¶æœåŠ¡ï¼ˆè§‚å¯Ÿè€…Aï¼‰
class MerchantService {
  handleOrder(order) {
    console.log(`å•†å®¶æ”¶åˆ°è®¢å•ï¼š${order.id}`);
  }
}

// éª‘æ‰‹æœåŠ¡ï¼ˆè§‚å¯Ÿè€…Bï¼‰
class RiderService {
  handleOrder(order) {
    console.log(`éª‘æ‰‹æŠ¢å•ï¼š${order.id}`);
  }
}

// çŸ­ä¿¡æœåŠ¡ï¼ˆè§‚å¯Ÿè€…Cï¼‰
class SMSService {
  handleOrder(order) {
    console.log(`å‘é€çŸ­ä¿¡ç»™ç”¨æˆ·ï¼š${order.userPhone}`);
  }
}

// åˆå§‹åŒ–æ—¶å¿…é¡»æŠŠæ‰€æœ‰æœåŠ¡ç»‘åœ¨ä¸€èµ·
const orderSystem = new OrderSystem();
orderSystem.addHandler(new MerchantService());
orderSystem.addHandler(new RiderService());
orderSystem.addHandler(new SMSService());

// ç”¨æˆ·ä¸‹å•
orderSystem.createOrder({ id: '123', userPhone: '138xxxx' });
```

::: warning ç¼ºç‚¹

- å¦‚æžœæ–°å¢žã€Œå¤§æ•°æ®åˆ†æžæœåŠ¡ã€ï¼Œå¿…é¡»ä¿®æ”¹ OrderSystem ä»£ç 
- å¦‚æžœçŸ­ä¿¡æœåŠ¡å´©æºƒï¼Œæ•´ä¸ªä¸‹å•æµç¨‹ä¼šæŠ¥é”™
- æ— æ³•æŸ¥çœ‹åŽ†å²è®¢å•å¤„ç†è®°å½•

:::

### æ–¹æ¡ˆ 2ï¼šå‘å¸ƒè®¢é˜…å®žçŽ°ï¼ˆæœ‰ä¸­é—´å•†ï¼‰

```bash
å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼š
[è®¢å•ä¸­å¿ƒ] â†’ [æ¶ˆæ¯ä¸­å¿ƒ] â†’ [å•†å®¶æœåŠ¡]
                  â†˜ï¸Ž â†’ [éª‘æ‰‹æœåŠ¡]
                  â†˜ï¸Ž â†’ [çŸ­ä¿¡æœåŠ¡]
                  â†˜ï¸Ž â†’ [å¤§æ•°æ®æœåŠ¡]ï¼ˆéšæ—¶æ–°å¢žï¼‰
```

ä»£ç å®žçŽ°ï¼š

```js
// æ¶ˆæ¯ä¸­å¿ƒï¼ˆBrokerï¼‰
const broker = {
  events: {},
  subscribe(event, callback) {
    this.events[event] = this.events[event] || [];
    this.events[event].push(callback);
  },
  publish(event, data) {
    // è®¢å•æ¶ˆæ¯å‘é€åˆ°ä¸­é—´å•†ï¼Œå…¶ä½™ç³»ç»ŸæŽ¥å—è®¢å•è‡ªè¡Œå¤„ç†å³å¯
    if (this.events[event]) {
      this.events[event].forEach(cb => cb(data));
    }
  },
};

// è®¢å•ä¸­å¿ƒï¼ˆå®Œå…¨ä¸çŸ¥é“è°ä¼šå¤„ç†è®¢å•ï¼‰
function createOrder(order) {
  console.log('è®¢å•åˆ›å»ºæˆåŠŸ');
  broker.publish('ORDER_CREATED', order); // åªè´Ÿè´£å‘æ¶ˆæ¯
}

// å•†å®¶æœåŠ¡ï¼ˆç‹¬ç«‹è¿è¡Œ,ç‹¬ç«‹å¤„ç†è®¢å•ä¿¡æ¯ï¼‰
broker.subscribe('ORDER_CREATED', order => {
  console.log(`å•†å®¶æ”¶åˆ°è®¢å•ï¼š${order.id}`);
});

// éª‘æ‰‹æœåŠ¡ï¼ˆç‹¬ç«‹è¿è¡Œ,ç‹¬ç«‹å¤„ç†è®¢å•ä¿¡æ¯ï¼‰
broker.subscribe('ORDER_CREATED', order => {
  console.log(`éª‘æ‰‹æŠ¢å•ï¼š${order.id}`);
});

// çŸ­ä¿¡æœåŠ¡ï¼ˆç‹¬ç«‹è¿è¡Œ,ç‹¬ç«‹å¤„ç†è®¢å•ä¿¡æ¯ï¼‰
broker.subscribe('ORDER_CREATED', order => {
  console.log(`å‘é€çŸ­ä¿¡ç»™ç”¨æˆ·ï¼š${order.userPhone}`);
});

// ç”¨æˆ·ä¸‹å•
createOrder({ id: '123', userPhone: '138xxxx' });

// â­ï¸ æ–°å¢žéœ€æ±‚ï¼šå¤§æ•°æ®åˆ†æž â†’ ä¸éœ€è¦æ”¹è®¢å•ä¸­å¿ƒä»£ç ï¼
broker.subscribe('ORDER_CREATED', order => {
  console.log(`è®°å½•è®¢å•æ•°æ®åˆ°å¤§æ•°æ®å¹³å°ï¼š${order.id}`);
});
```

::: tip ä¼˜åŠ¿

- è®¢å•ä¸­å¿ƒæ°¸è¿œä¸éœ€è¦ä¿®æ”¹ï¼Œæ— è®ºåŠ å¤šå°‘æ–°åŠŸèƒ½
- æŸä¸ªæœåŠ¡å´©æºƒä¸å½±å“å…¶ä»–æœåŠ¡ â€‹ï¼ˆå¦‚çŸ­ä¿¡æœåŠ¡æŒ‚äº†ï¼Œå•†å®¶ä»èƒ½æŽ¥å•ï¼‰,å› ä¸ºæ²¡æœ‰åœ¨å†…éƒ¨è°ƒç”¨å„ç³»ç»Ÿå¤„ç†è®¢å•ï¼Œè€Œæ˜¯å„ç³»ç»Ÿå•ç‹¬å¤„ç†è®¢å•
- å¯ä»¥éšæ—¶æŸ¥çœ‹æˆ–é‡æ”¾åŽ†å²æ¶ˆæ¯

:::

## å‘å¸ƒè®¢é˜…çš„é«˜çº§ç”¨æ³•

### åœºæ™¯ 1ï¼šè·¨ç³»ç»Ÿé€šä¿¡ï¼ˆè§‚å¯Ÿè€…æ¨¡å¼æ ¹æœ¬åšä¸åˆ°ï¼‰

æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­

### åœºæ™¯ 2ï¼šåŠ¨æ€åŠŸèƒ½å¼€å…³ï¼ˆè§‚å¯Ÿè€…æ¨¡å¼éš¾ä»¥å®žçŽ°ï¼‰

éœ€æ±‚ â€‹ï¼šæ ¹æ®é…ç½®åŠ¨æ€å¼€å¯/å…³é—­æŸäº›æ¶ˆæ¯å¤„ç†é€»è¾‘

```js
// å‘å¸ƒè®¢é˜…å®žçŽ°åŠ¨æ€å¼€å…³
const features = {
  analytics: true,
  premiumAlert: false,
};

// åŠ¨æ€è®¢é˜…
if (features.analytics) {
  pubsub.subscribe('user.login', user => {
    analytics.track(user);
  });
}

if (features.premiumAlert) {
  pubsub.subscribe('user.login', user => {
    if (user.isPremium) sendAlert();
  });
}

// è¿è¡Œæ—¶å¯ä»¥åŠ¨æ€è°ƒæ•´
setTimeout(() => {
  features.premiumAlert = true; // ç«‹å³ç”Ÿæ•ˆ
}, 10000);
```

### åœºæ™¯ 3ï¼šæ¶ˆæ¯æŒä¹…åŒ–ä¸Žå›žæº¯ï¼ˆè§‚å¯Ÿè€…æ¨¡å¼æ— æ³•å®žçŽ°ï¼‰

éœ€æ±‚ â€‹ï¼šæ–°ä¸Šçº¿çš„æœåŠ¡éœ€è¦å¤„ç†åŽ†å²æ¶ˆæ¯

```js
// å‘å¸ƒè®¢é˜…+æ¶ˆæ¯æŒä¹…åŒ–å®žçŽ°
class PersistentPubSub {
  constructor() {
    this.channels = {};
    this.messageLog = new MessageLog(); // æŒä¹…åŒ–å­˜å‚¨
  }

  publish(channel, message) {
    this.messageLog.save(channel, message); // å…ˆæŒä¹…åŒ–
    // å†é€šçŸ¥çŽ°æœ‰è®¢é˜…è€…
    notifySubscribers(channel, message);
  }

  subscribe(channel, callback, options = {}) {
    if (options.replay) {
      // æ–°è®¢é˜…è€…èŽ·å–åŽ†å²æ¶ˆæ¯
      this.messageLog.replay(channel, callback);
    }
    registerSubscriber(channel, callback);
  }
}

// æ–°æœåŠ¡èŽ·å–æœ€è¿‘7å¤©çš„ç™»å½•äº‹ä»¶
pubsub.subscribe(
  'user.login',
  user => {
    fraudDetection.check(user);
  },
  { replay: '7d' },
);
```
